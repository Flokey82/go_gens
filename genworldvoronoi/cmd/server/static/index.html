<html>

<head>
  <link rel="stylesheet" href="vendor/leaflet-1.9.3/leaflet.css" />
  <style>
    html,
    body,
    #map {
      width: 100%;
      height: 100%;
      padding: 0;
      margin: 0;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    div.text-labels {
      font-size: 1em;
      font-weight: bold;
      color: #fff;
      text-shadow: 0 0 3px #000;
      width: auto;
    }

    div.text-labels span {
      white-space: nowrap;
    }
  </style>
</head>

<body>
  <div id="map"></div>
  <script src="vendor/leaflet-1.9.3/leaflet.js"></script>
  <script src="vendor/leaflet-hash-0.2.1/leaflet-hash.js"></script>
  <script type="text/javascript">

    var displayMode = 0;
    var displayModeMax = 6;
    var windVector = false;

    var map = L.map('map', {
      crs: L.CRS.EPSG3857,
    }).setView([0, 0], 1);

    new L.Hash(map);

    var tl = L.tileLayer('tiles/{z}/{x}/{y}?d={d}&wind={wind}', {
      attribution: '&copy;',
      maxZoom: 20,
      minZoom: 1,
      tms: true,
      d: function () {
        return displayMode;
      },
      wind: function () {
        return windVector;
      }
    }).addTo(map);


    var layerGroup = L.layerGroup().addTo(map);

    var geojsonLayer = L.geoJSON().addTo(map);
    geojsonLayer.addTo(map);

    var loadGeoJSON = function (url, options) {
      var xhr = new XMLHttpRequest();
      xhr.open('GET', url);
      xhr.onload = function () {
        if (xhr.status === 200) {
          var geojson = JSON.parse(xhr.responseText);
          L.geoJSON(geojson, options).addTo(geojsonLayer);
        } else {
          console.log('Error: ' + xhr.status);
        }
      };
      xhr.send();
    };

    // Load the geojson layer when we load a tile
    map.on('moveend', function () {
      // First clear the geojson layer
      geojsonLayer.clearLayers();
      var bounds = map.getBounds();
      var zoom = map.getZoom();
      var params = zoom + '/' + bounds.getNorth() + '/' + bounds.getWest() + '/' + bounds.getSouth() + '/' + bounds.getEast();

      // Load city markers.
      loadGeoJSON('geojson_cities/' + params, {
        onEachFeature: function (feature, layer) {
          var prop = feature.properties;
          layer.bindPopup(
            '<span style="font-size:8px;">' +
            '<b>' + prop.name + '</b> (' + prop.type + ')<br/>' +
            '<p><b>' + prop.flavortext + '</b></p>' +
            '<p>' + 
            'Population: ' + prop.population + ' / ' + prop.maxpop + 
            ' (max ' + prop.maxpoplimit + ' growth ' + prop.popgrowth.toFixed(3) + ')<br/>' +
            'Settled: ' + prop.settled + 'yrs ago<br/>' +
            'Culture: ' + prop.culture + '<br/>' +
            'Biome: ' + prop.biome + '<br/>' +
            'Coords: ' + prop.coordinates + '<br/>' +
            'Attractiveness: ' + prop.attractiveness.toFixed(3) + '<br/>' +
            'Economic: ' + prop.economic.toFixed(3) + ' / ' +
            'Agriculture: ' + prop.agriculture.toFixed(3) + ' / ' +
            'Trade: ' + prop.trade.toFixed(3) + ' / ' +
            'Resources: ' + prop.resources.toFixed(3) + '<br/>' +
            'Tradepartners: ' + prop.tradepartners + ' (Radius: ' + prop.radius.toFixed(3) + 'km)<br/>' +
            '</p>' +
            '<p>' + 
            '<b>Resources:</b><br/>' +
            '<span style="font-size:7px;">' + (prop.reslist || []).join('<br/>') + '</span>' +
          '</p>'+
            '<p>' + 
            '<b>History:</b> (last 10)<br/>' +
            '<span style="font-size:7px;">' + (prop.history || []).join('<br/>') + '</span>'+
          '</p></span>');
        },
        pointToLayer: function (feature, latlng) {
          return L.marker(latlng, {
            icon: L.divIcon({
              className: 'text-labels',   // Set class for CSS styling
              html: '<span>&#x2022;' + feature.properties.name + '</span>'
            }),
            zIndexOffset: 1000     // Make appear above other map features
          })
        }
      });

      // Load all borders.
      loadGeoJSON('geojson_borders/' + params, {
        style: function (feature) {
          return {
            color: 'darkred',
            opacity: 0.5,
          };
        },
        onEachFeature: function (feature, layer) {
          layer.bindPopup('ID: ' + feature.id);
        }
      });
    });

    function newCustomControl(startLabel, onClick) {
      var control = L.Control.extend({
        options: {
          position: 'topleft'
        },
        onAdd: function (map) {
          var container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
          container.style.backgroundColor = 'white';
          container.style.userSelect = 'none';

          var link = document.createElement('a');
          link.innerText = startLabel;
          link.style.cursor = 'pointer';
          container.appendChild(link);

          container.onclick = function() {
            onClick(link);
          };
          return container;
        },
      });
      return control;
    }

    // Add our custom control for toggling borders.
    var borderControl = newCustomControl('D:' + displayMode, function (link) {
          // Loop though all display modes.
          displayMode = (displayMode + 1) % displayModeMax;
          link.innerText = 'D:' + displayMode;
          tl.redraw();
        });

    map.addControl(new borderControl());

    // Add our custom control for toggling wind vectors.
    var windControl = newCustomControl('W:' + windVector, function (link) {
          // Toggle wind vector display.
          windVector = !windVector;
          link.innerText = 'W:' + windVector;
          tl.redraw();
        });
    map.addControl(new windControl());

  </script>
</body>

</html>