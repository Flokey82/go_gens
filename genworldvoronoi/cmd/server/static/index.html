<html>

<head>
  <link rel="stylesheet" href="vendor/leaflet-1.9.3/leaflet.css" />
  <style>
    html,
    body,
    #map {
      width: 100%;
      height: 100%;
      padding: 0;
      margin: 0;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    div.text-labels {
      font-size: 1em;
      font-weight: bold;
      color: #fff;
      text-shadow: 0 0 3px #000;
      width: auto;
    }

    div.text-labels span {
      white-space: nowrap;
    }
  </style>
</head>

<body>
  <div id="map"></div>
  <script src="vendor/leaflet-1.9.3/leaflet.js"></script>
  <script src="vendor/leaflet-hash-0.2.1/leaflet-hash.js"></script>
  <script type="text/javascript">

    var map = L.map('map', {
      crs: L.CRS.EPSG3857,
    }).setView([0, 0], 1);

    new L.Hash(map);

    L.tileLayer('tiles/{z}/{x}/{y}', {
      attribution: '&copy;',
      maxZoom: 20,
      minZoom: 1,
      tms: true,
    }).addTo(map);


    var layerGroup = L.layerGroup().addTo(map);

    var geojsonLayer = L.geoJSON().addTo(map);
    geojsonLayer.addTo(map);

    var loadGeoJSON = function (url, options) {
      var xhr = new XMLHttpRequest();
      xhr.open('GET', url);
      xhr.onload = function () {
        if (xhr.status === 200) {
          var geojson = JSON.parse(xhr.responseText);
          L.geoJSON(geojson, options).addTo(geojsonLayer);
        } else {
          console.log('Error: ' + xhr.status);
        }
      };
      xhr.send();
    };

    // Load the geojson layer when we load a tile
    map.on('moveend', function () {
      // First clear the geojson layer
      geojsonLayer.clearLayers();
      var bounds = map.getBounds();
      var zoom = map.getZoom();
      var params = zoom + '/' + bounds.getNorth() + '/' + bounds.getWest() + '/' + bounds.getSouth() + '/' + bounds.getEast();

      // Load city markers.
      loadGeoJSON('geojson_cities/' + params, {
        onEachFeature: function (feature, layer) {
          layer.bindPopup(
            '<span style="font-size:8px;">' +
            'Name: ' + feature.properties.name +
            '<br/>Population: ' + feature.properties.population +
            '<br/>Pop Growth: ' + feature.properties.popgrowth.toFixed(3) +
            '<br/>Max Pop: ' + feature.properties.maxpop +
            '<br/>Max Pop Limit: ' + feature.properties.maxpoplimit +
            '<br/>Type: ' + feature.properties.type +
            '<br/>Culture: ' + feature.properties.culture +
            '<br/>Settled: ' + feature.properties.settled + 'yrs ago' +
            '<br/>Biome: ' + feature.properties.biome +
            '<br/>Attractiveness: ' + feature.properties.attractiveness.toFixed(3) +
            '<br/>Economic: ' + feature.properties.economic.toFixed(3) +
            '<br/>Agriculture: ' + feature.properties.agriculture.toFixed(3) +
            '<br/>Trade: ' + feature.properties.trade.toFixed(3) +
            '<br/>Resources: ' + feature.properties.resources.toFixed(3) +
            '<br/>Radius: ' + feature.properties.radius.toFixed(3) + 'km' +
            '<br/>Tradepartners: ' + feature.properties.tradepartners +
            '<br/>' + feature.properties.flavortext +
            '</span>' +
            '<br/>Resources:<br/>' +
            '<span style="font-size:5px;">' + (feature.properties.reslist || []).join('<br/>') + '</span>' +
            '<br/>History:<br/>' +
            '<span style="font-size:5px;">' + (feature.properties.history || []).join('<br/>') + '</span>');
        },
        pointToLayer: function (feature, latlng) {
          return L.marker(latlng, {
            icon: L.divIcon({
              className: 'text-labels',   // Set class for CSS styling
              html: '<span>&#x2022;' + feature.properties.name + '</span>'
            }),
            zIndexOffset: 1000     // Make appear above other map features
          })
        }
      });

      // Load all borders.
      loadGeoJSON('geojson_borders/' + params, {
        style: function (feature) {
          return {
            color: 'darkred',
            opacity: 0.5,
          };
        },
        onEachFeature: function (feature, layer) {
          layer.bindPopup('ID: ' + feature.id);
        }
      });
    });

    // Add our custom control for toggling borders.
    var borderControl = L.Control.extend({
      options: {
        position: 'topleft'
        //control position - allowed: 'topleft', 'topright', 'bottomleft', 'bottomright'
      },
      onAdd: function (map) {
        var container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
        container.style.backgroundColor = 'white';
        //container.style.width = '30px';
        container.style.height = '30px';

        var link = document.createElement('a');
        link.innerText = 'B';
        link.style.cursor = 'pointer';
        container.appendChild(link);

        container.onclick = function () {
          console.log('TODO: Query geoJSON for all borders in view and add them to the layerGroup.');
        }
        return container;
      },
    });

    map.addControl(new borderControl());

  </script>
</body>

</html>